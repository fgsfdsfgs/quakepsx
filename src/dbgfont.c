#include <ctype.h>
#include <sys/types.h>
#include <psxetc.h>
#include <psxapi.h>
#include <psxgte.h>
#include <psxgpu.h>
#include <psxcd.h>

#include "dbgfont.h"

#define MAX_CHAR_SIZE 8

const u8 sys_dbgfont[DBGFONT_NUMCHRS][DBGFONT_HEIGHT] = {
  // +
  {
    0b00000000,
    0b00011000,
    0b01111110,
    0b00011000,
    0b00000000,
  },
  // ,
  {
    0b00000000,
    0b00000000,
    0b00000000,
    0b00100000,
    0b01000000,
  },
  // -
  {
    0b00000000,
    0b00000000,
    0b00111100,
    0b00000000,
    0b00000000,
  },
  // .
  {
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b01000000,
  },
  // /
  {
    0b00000010,
    0b00000100,
    0b00001000,
    0b00010000,
    0b00100000,
  },
  // 0
  {
    0b00111110,
    0b01000010,
    0b01000010,
    0b01000010,
    0b01111100,
  },
  // 1
  {
    0b00001000,
    0b00011000,
    0b00001000,
    0b00001000,
    0b00001000,
  },
  // 2
  {
    0b01111100,
    0b00000010,
    0b00111100,
    0b01000000,
    0b01111110,
  },
  // 3
  {
    0b01111100,
    0b00000010,
    0b00011100,
    0b00000010,
    0b01111100,
  },
  // 4
  {
    0b01000010,
    0b01000010,
    0b01111110,
    0b00000010,
    0b00000010,
  },
  // 5
  {
    0b01111110,
    0b01000000,
    0b00111100,
    0b00000010,
    0b01111100,
  },
  // 6
  {
    0b00111110,
    0b01000000,
    0b01111100,
    0b01000010,
    0b00111100,
  },
  // 7
  {
    0b01111110,
    0b00000010,
    0b00000100,
    0b00000100,
    0b00000100,
  },
  // 8
  {
    0b00111100,
    0b01000010,
    0b00111100,
    0b01000010,
    0b00111100,
  },
  // 9
  {
    0b00111100,
    0b01000010,
    0b00111110,
    0b00000010,
    0b01111100,
  },
  // :
  {
    0b00000000,
    0b00010000,
    0b00000000,
    0b00010000,
    0b00000000,
  },
  // ;
  {
    0b00000000,
    0b00010000,
    0b00000000,
    0b00010000,
    0b00100000,
  },
  // <
  {
    0b00001000,
    0b00110000,
    0b01000000,
    0b00110000,
    0b00001000,
  },
  // =
  {
    0b00000000,
    0b00111100,
    0b00000000,
    0b00111100,
    0b00000000,
  },
  // >
  {
    0b00010000,
    0b00001100,
    0b00000010,
    0b00001100,
    0b00010000,
  },
  // ?
  {
    0b01111110,
    0b00000010,
    0b00111110,
    0b00000000,
    0b00110000,
  },
  // @
  {
    0b00000000,
    0b00111100,
    0b00111100,
    0b00111100,
    0b00000000,
  },
  // A
  {
    0b00111100,
    0b01000010,
    0b01111110,
    0b01000010,
    0b01000010,
  },
  // B
  {
    0b01111100,
    0b01000010,
    0b01111100,
    0b01000010,
    0b01111100,
  },
  // C
  {
    0b00111110,
    0b01000000,
    0b01000000,
    0b01000000,
    0b00111110,
  },
  // D
  {
    0b01111100,
    0b01000010,
    0b01000010,
    0b01000010,
    0b01111100,
  },
  // E
  {
    0b01111110,
    0b01000000,
    0b01111110,
    0b01000000,
    0b01111110,
  },
  // F
  {
    0b01111110,
    0b01000000,
    0b01111110,
    0b01000000,
    0b01000000,
  },
  // G
  {
    0b00111110,
    0b01000000,
    0b01000110,
    0b01000010,
    0b00111100,
  },
  // H
  {
    0b01000010,
    0b01000010,
    0b01111110,
    0b01000010,
    0b01000010,
  },
  // I
  {
    0b00011100,
    0b00001000,
    0b00001000,
    0b00001000,
    0b00011100,
  },
  // J
  {
    0b00000010,
    0b00000010,
    0b00000010,
    0b00000010,
    0b01111100,
  },
  // K
  {
    0b01000110,
    0b01011000,
    0b01100000,
    0b01011000,
    0b01000110,
  },
  // L
  {
    0b01000000,
    0b01000000,
    0b01000000,
    0b01000000,
    0b01111110,
  },
  // M
  {
    0b01000010,
    0b01100110,
    0b01011010,
    0b01000010,
    0b01000010,
  },
  // N
  {
    0b01000010,
    0b01100010,
    0b01011010,
    0b01000110,
    0b01000010,
  },
  // O
  {
    0b00111100,
    0b01000010,
    0b01000010,
    0b01000010,
    0b00111100,
  },
  // P
  {
    0b01111100,
    0b01000010,
    0b01111100,
    0b01000000,
    0b01000000,
  },
  // Q
  {
    0b00111100,
    0b01000010,
    0b01000010,
    0b01000110,
    0b00111101,
  },
  // R
  {
    0b01111100,
    0b01000010,
    0b01111100,
    0b01000010,
    0b01000010,
  },
  // S
  {
    0b00111110,
    0b01000000,
    0b00111100,
    0b00000010,
    0b01111100,
  },
  // T
  {
    0b01111110,
    0b00011000,
    0b00011000,
    0b00011000,
    0b00011000,
  },
  // U
  {
    0b01000010,
    0b01000010,
    0b01000010,
    0b01000010,
    0b00111100,
  },
  // V
  {
    0b01000010,
    0b01000010,
    0b01000010,
    0b00100100,
    0b00011000,
  },
  // W
  {
    0b01000010,
    0b01000010,
    0b01011010,
    0b01011010,
    0b00100100,
  },
  // X
  {
    0b01000010,
    0b00100100,
    0b00011000,
    0b00100100,
    0b01000010,
  },
  // Y
  {
    0b01000010,
    0b01000010,
    0b00111110,
    0b00000010,
    0b01111100,
  },
  // Z
  {
    0b01111110,
    0b00000110,
    0b00011000,
    0b01100000,
    0b01111110,
  },
};

static int dbg_x_start = 0;
static int dbg_x = 0;
static int dbg_y = 0;
static u16 dbg_bgcolor = 0;

void Dbg_PrintReset(const int start_x, const int start_y, const u8 bg_r, const u8 bg_g, const u8 bg_b) {
  dbg_x_start = start_x;
  dbg_x = start_x;
  dbg_y = start_y;
  dbg_bgcolor = (bg_r >> 3) | ((bg_g >> 3) << 5) | ((bg_b >> 3) << 10); 
}

void Dbg_PrintString(const char *s) {
  // upload size has to be a multiple of 16
  u16 chrtex[MAX_CHAR_SIZE][MAX_CHAR_SIZE];
  RECT r;
  r.w = 8;
  r.h = 8;

  for (int y = 0; y < MAX_CHAR_SIZE; ++y)
    for (int x = 0; x < MAX_CHAR_SIZE; ++x)
      chrtex[y][x] = dbg_bgcolor;

  while (*s) {
    const int ch = toupper(*s);
    switch (ch) {
    case '\n':
      dbg_x = dbg_x_start;
      dbg_y += DBGFONT_HEIGHT + 1;
      break;
    case DBGFONT_START ... DBGFONT_END:
      // unpack char
      for (int y = 0; y < DBGFONT_HEIGHT; ++y) {
        const u8 line = sys_dbgfont[ch - DBGFONT_START][y];
        for (int x = 0; x < DBGFONT_WIDTH; ++x)
          chrtex[y][x] = (line & (0x80 >> x)) ? 0xFFFF : dbg_bgcolor;
      }
      // upload it directly into the screen immediately
      r.x = dbg_x;
      r.y = dbg_y;
      LoadImage2(&r, (const u32 *)chrtex);
      /* fallthrough */
    default:
      dbg_x += DBGFONT_WIDTH;
      if (dbg_x > 320 - DBGFONT_WIDTH) {
        dbg_x = dbg_x_start;
        dbg_y += DBGFONT_HEIGHT + 1;
      }
      break;
    }
    ++s;
  }
}
